{% extends 'base.html' %}

{% block script %}
    
	<script type="text/javascript" charset="utf-8">
        // The width and height of the captured photo. We will set the
        // width to the value defined here, but the height will be
        // calculated based on the aspect ratio of the input stream.
    
        const width = 310; // We will scale the photo width to this
        let height = 0; // This will be computed based on the input stream
    
        // |streaming| indicates whether or not we're currently streaming
        // video from the camera. Obviously, we start at false.
    
        let streaming = false;
    
        // The various HTML elements we need to configure or control. These
        // will be set by the startup() function.
        function getRandomInt(max) {
        return Math.floor(Math.random() * max);
        }

        let video = null;
        let canvas = null;
        let photo = null;

        function startup() {
            video = document.getElementById("video");
            video.style.display="none";
            canvas = document.getElementById("canvas");
            canvas.style.display="none";
            photo = document.getElementById("photo");
            photo.style.display="none";

            navigator.mediaDevices
            .getUserMedia({ video: true, audio: false })
            .then((stream) => {
                video.srcObject = stream;
                video.play();
            })
            .catch((err) => {
                console.error(`An error occurred: ${err}`);
            });

            video.addEventListener(
            "canplay",
            (ev) => {
                if (!streaming) {
                height = video.videoHeight / (video.videoWidth / width);

                // Firefox currently has a bug where the height can't be read from
                // the video, so we will make assumptions if this happens.

                if (isNaN(height)) {
                    height = width / (4 / 3);
                }

                video.setAttribute("width", width);
                video.setAttribute("height", height);
                canvas.setAttribute("width", width);
                canvas.setAttribute("height", height);
                streaming = true;
                }
            },
            false,
            );
        }

        function takepicture() {
            const context = canvas.getContext("2d");
            if (width && height) {
                canvas.width = width;
                canvas.height = height;
                context.drawImage(video, 0, 0, width, height);

                const data = canvas.toDataURL("image/png");
                photo.setAttribute("src", data);
            }
        }


        $(document).ready(function(){
            startup();
            namespace = '{{prefix}}';
            var msgCount = 1;
            var client_id = Date.now()
            var spk='USER';
            var port='{{port}}';
            var converter = new showdown.Converter();
            if(port.length>0){           
                var ws = new WebSocket('{{protocol}}://{{server}}:{{port}}' + namespace+`${client_id}`);
            }else{
                var ws = new WebSocket('{{protocol}}://{{server}}' + namespace+`${client_id}`);
            }
            ws.addEventListener("open", (event) => {
                var preferences={};
                {% for k,v in data.items() %}
                preferences["{{k}}"]="{{v}}";
                {% endfor %}
                ws.send(JSON.stringify({'cmd':'start','conversation':"{{chat_name}}",'data':preferences }));
            });

            $('#send').click(function(e){sendMSG(e)});

            $('#msg_input').focus();

            function sleep(milliseconds) {
                  const date = Date.now();
                  let currentDate = null;
                  do {
                          currentDate = Date.now();
                        } while (currentDate - date < milliseconds);
            }

            function sendMSG(e) {
                var msg = String($('#msg_input').val());
                if(msg.trim().length>0){
                    takepicture();
                    verify().then((data) => ws.send(JSON.stringify({'cmd':'verify','vectorStr':data,'client_id':client_id})));
                    ws.send(JSON.stringify({'cmd':'input completed','msg':msg,'client_id':client_id}));
                    showUserMessage(msg,getCurrentTimestamp());
                    $('#msg_input').val('');
                    msgCount += 1;
      			    return false;
                }
    		}

            // Get the input field
            var input = document.getElementById("msg_input");

            // Execute a function when the user presses a key on the keyboard
            input.addEventListener("keypress", function(event) {
                  // If the user presses the "Enter" key on the keyboard
                  if (event.key === "Enter") {
                          // Cancel the default action, if needed
                          event.preventDefault();
                          // Trigger the button element with a click
                          document.getElementById("send").click();
                        }
            });

            ws.onmessage = function(event) {
				data=JSON.parse(event.data);
                // SAY
				if(data.cmd=="say"){
                    html = converter.makeHtml(data.msg);
                    showBotMessage(html,getCurrentTimestamp());
                    sleep(400);
                    //let utter = new SpeechSynthesisUtterance();
                    //utter.lang = 'es-MX';
                    //utter.text = data.msg;
                    //utter.volume = 0.5;
                    // speak
                    //window.speechSynthesis.speak(utter);
				};
                // Finish
	            if(data.cmd=="finish"){
                    document.getElementById('msg_input').disabled = true;
                    document.getElementById('chat_window').disabled = true;
                    document.getElementById('bye_message').removeAttribute('hidden');
                    window.scrollTo(0, document.body.scrollHeight);
				};
                //Verify
                if(data.cmd=="verify"){
                    if(!data.verification){
                        window.location.replace("/cv/{{chat_name}}/inicio");
                    };
                };
            };

            ws.onclose = function(e) {
                    console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
                        if(port.length>0){
                                var ws = new WebSocket('{{protocol}}://{{server}}:{{port}}' + namespace+`${client_id}`);
                            }else{
                                var ws = new WebSocket('{{protocol}}://{{server}}' + namespace+`${client_id}`);
                        }
                  };

            ws.onerror = function(err) {
                      console.error('Socket encountered error: ', err.message, 'Closing socket');
                      ws.close();
                    };
        });

        //Verifies the identity of the user every time they send a message
        async function verify() {
            const MODEL_URL = '/cv/static/models/weights';

            await faceapi.loadSsdMobilenetv1Model(MODEL_URL);
            await faceapi.loadFaceLandmarkModel(MODEL_URL);
            await faceapi.loadFaceRecognitionModel(MODEL_URL);

            let result = await faceapi.detectSingleFace(photo).withFaceLandmarks().withFaceDescriptor();
            if (result){
                return Object.values(result.descriptor).toString();
            }
            else{
                return "error";
            }
        }
    </script>
{% endblock %}

{% block content %}
	<div class="container">
		<div class="row padded_row">
				<div id="chat_window" class="chat_window">
					<div class="top_menu">
                        <div class="title">Mar üê∂</div>
					</div>

					<!-- dynamically rendered -->
					<ul class="messages"></ul>

					<!-- input -->
					<div class="bottom_wrapper">
						<input id="msg_input" placeholder="Escribe aqu√≠"/>
                        <div id="send" class="app_button_1">Enviar</div>
					</div>
				</div>
		</div>
		<div id="bye_message" class="row padded_row" hidden="True">
            <div class="col-md-4 mx-auto">
            <div class="card" style="width: 18rem;">
                <div class="card-body">
                <h5 class="card-title">Gracias por conversar</h5>
                <h6 class="card-subtitle mb-2 text-body-secondary">Cuestionario</h6>
                    <p class="card-text">Ahora te pedimos que nos apoyes respondiendo el siguiente cuestionario.</p>
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLSfl4UZkYf9FLkoplMQGG9zsHbRTuFwgybZojD-2RfAuJqBx3Q/viewform?usp=sf_link" class="btn btn-success">Ir a cuestionario</a>
                </div>
            </div>
            </div>
        </div>

<p id="messageOne"></p>
</div>
<div class="camera">
    <video id="video">Video stream not available.</video>
</div>
<canvas id="canvas"> </canvas>
<div class="output">
    <img id="photo" alt="The screen capture will appear in this box." />
</div>

  

{% endblock %}
